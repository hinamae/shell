#!/bin/bash


#commnameで指定されたプロセスが見つからない場合に、自動で再起動を行って復旧させる
#このスクリプトはcronに登録して定期的に実行する
#このスクリプトがwebサーバという、リクエストに対してコンテンツを返すだけのソフトウェアを対象としているため、気軽に再起動を行うことができる
#プロキシサーバやwebサーバはプロセスが停止していた際に、気軽に再起動して問題ない
#データベースサーバなどが停止している場合などに安易に適用するのは危険
#事前検証が必要


#監視するプロセスのコマンド

commname="/usr/sbin/httpd"

#監視プロセスの起動コマンド
#apachectl= アパッチを起動させるコマンド

start="/user/bin/apachectl start"

#監視対象コマンドのプロセス数をカウントする

#ps aオプション＝他の端末を含め操作端末のプロセスを表示する ttysはターミナル！（unix系の標準入出力する端末）
#ps xオプション＝現在実行中のプロセスを表示
#ps -oオプション＝表示したい項目（今回はコマンド）を指定して、表示する

#実行されているプロセスのコマンドを抜き出し
#commname の部分を抜き出し
#grepでcommnameを使用して抜き出しているため、grep抜き出しの対象となってしまっているため、それは省く
#wc＝ファイルの文字数や単語数などを数える
#-lオプション=行数を抜き出す

count=$(ps ax -o command | grep "$commname" | grep -v "^grep" | wc -l)

#grepコマンドの出力結果が０行の場合にはプロセスが存在しないため異常とみなしてプロセスを起動する
if [ "$count" -eq 0 ] ; then
	#日付を入れてログ出力
	date_str=$(date '+%Y/%m/%d %H:%M:%S')
	echo "[$date_str] プロセス $commname が見つかりません" >&2
	echo "[$date_str] プロセス $commname を起動" >&2

	#監視プロセスの起動
	$start

fi
	 
